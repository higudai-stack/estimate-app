<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>見積書作成（叩き台）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    label { display: block; font-size: 12px; color: #555; margin-top: 8px; }
    input, textarea { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; }
    th { background: #f7f7f7; text-align: left; }
    .right { text-align: right; }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    button { padding: 8px 12px; border: 1px solid #ccc; background: #fff; border-radius: 6px; cursor: pointer; }
    button.primary { border-color: #333; }
    .totals { margin-top: 12px; display: grid; grid-template-columns: 1fr 220px; gap: 12px; align-items: start; }
    .totals table { margin: 0; }
    .note { font-size: 12px; color: #666; margin-top: 8px; }

    /* 印刷用 */
    @media print {
      .no-print { display: none !important; }
      body { margin: 0; }
      .card { border: none; padding: 0; }
      input, textarea { border: none; padding: 0; }
      table, th, td { border-color: #999; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const STORAGE_KEY = "estimate_draft_v1";

    function yen(n) {
      const v = Number(n || 0);
      return v.toLocaleString("ja-JP");
    }

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function defaultEstimate() {
      return {
        estimateNo: "EST-" + new Date().getTime(),
        issueDate: todayISO(),
        validUntil: "",
        customer: { company: "", person: "", address: "" },
        issuer:  { company: "", person: "", address: "", tel: "" },
        taxRate: 0.10,
        rounding: "floor", // floor | round | ceil
        items: [
          { name: "作業費", qty: 1, unitPrice: 0 }
        ],
        notes: ""
      };
    }

    function applyRounding(value, mode) {
      if (mode === "ceil") return Math.ceil(value);
      if (mode === "round") return Math.round(value);
      return Math.floor(value);
    }

    function App() {
      const [est, setEst] = React.useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try { return JSON.parse(saved); } catch(e) {}
        }
        return defaultEstimate();
      });

      const subtotal = React.useMemo(() => {
        const sum = est.items.reduce((acc, it) => {
          const qty = Number(it.qty || 0);
          const up  = Number(it.unitPrice || 0);
          return acc + (qty * up);
        }, 0);
        return applyRounding(sum, est.rounding);
      }, [est.items, est.rounding]);

      const tax = React.useMemo(() => {
        return applyRounding(subtotal * Number(est.taxRate || 0), est.rounding);
      }, [subtotal, est.taxRate, est.rounding]);

      const total = subtotal + tax;

      function update(path, value) {
        setEst(prev => {
          const next = structuredClone(prev);
          // path例: "customer.company"
          const keys = path.split(".");
          let obj = next;
          for (let i = 0; i < keys.length - 1; i++) obj = obj[keys[i]];
          obj[keys[keys.length - 1]] = value;
          return next;
        });
      }

      function updateItem(idx, key, value) {
        setEst(prev => {
          const next = structuredClone(prev);
          next.items[idx][key] = value;
          return next;
        });
      }

      function addItem() {
        setEst(prev => {
          const next = structuredClone(prev);
          next.items.push({ name: "", qty: 1, unitPrice: 0 });
          return next;
        });
      }

      function removeItem(idx) {
        setEst(prev => {
          const next = structuredClone(prev);
          next.items.splice(idx, 1);
          if (next.items.length === 0) next.items.push({ name: "", qty: 1, unitPrice: 0 });
          return next;
        });
      }

      function saveDraft() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(est));
        alert("下書きを保存しました。");
      }

      function loadDraft() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return alert("保存データが見つかりません。");
        try {
          setEst(JSON.parse(saved));
          alert("下書きを読み込みました。");
        } catch (e) {
          alert("読み込みに失敗しました。");
        }
      }

      function newEstimate() {
        if (!confirm("新規作成します。現在の内容は消えます（保存していない場合）。よろしいですか？")) return;
        setEst(defaultEstimate());
      }

      function printPDF() {
        window.print();
      }

      return (
        <div>
          <h1>見積書作成（叩き台）</h1>

          <div className="grid">
            <div className="card">
              <h2 style={{fontSize: "14px", margin: 0}}>見積情報</h2>
              <label>見積番号</label>
              <input value={est.estimateNo} onChange={e => update("estimateNo", e.target.value)} />
              <label>発行日</label>
              <input type="date" value={est.issueDate} onChange={e => update("issueDate", e.target.value)} />
              <label>有効期限</label>
              <input type="date" value={est.validUntil} onChange={e => update("validUntil", e.target.value)} />
              <label>消費税率</label>
              <input type="number" step="0.01" value={est.taxRate} onChange={e => update("taxRate", e.target.value)} />
              <label>端数処理</label>
              <select value={est.rounding} onChange={e => update("rounding", e.target.value)} style={{width:"100%", padding:"8px", borderRadius:"6px"}}>
                <option value="floor">切り捨て</option>
                <option value="round">四捨五入</option>
                <option value="ceil">切り上げ</option>
              </select>
            </div>

            <div className="card">
              <h2 style={{fontSize: "14px", margin: 0}}>宛先</h2>
              <label>会社名</label>
              <input value={est.customer.company} onChange={e => update("customer.company", e.target.value)} />
              <label>担当者</label>
              <input value={est.customer.person} onChange={e => update("customer.person", e.target.value)} />
              <label>住所</label>
              <textarea rows="3" value={est.customer.address} onChange={e => update("customer.address", e.target.value)} />
            </div>

            <div className="card">
              <h2 style={{fontSize: "14px", margin: 0}}>発行者（自社）</h2>
              <label>会社名</label>
              <input value={est.issuer.company} onChange={e => update("issuer.company", e.target.value)} />
              <label>担当者</label>
              <input value={est.issuer.person} onChange={e => update("issuer.person", e.target.value)} />
              <label>住所</label>
              <textarea rows="3" value={est.issuer.address} onChange={e => update("issuer.address", e.target.value)} />
              <label>TEL</label>
              <input value={est.issuer.tel} onChange={e => update("issuer.tel", e.target.value)} />
            </div>

            <div className="card">
              <h2 style={{fontSize: "14px", margin: 0}}>備考</h2>
              <label>備考欄</label>
              <textarea rows="8" value={est.notes} onChange={e => update("notes", e.target.value)} />
              <div className="note">印刷時は入力枠が消えて“見積書っぽく”表示されます。</div>
            </div>
          </div>

          <div className="card" style={{marginTop:"12px"}}>
            <h2 style={{fontSize: "14px", margin: 0}}>明細</h2>
            <table>
              <thead>
                <tr>
                  <th style={{width:"50%"}}>品目</th>
                  <th style={{width:"12%"}} className="right">数量</th>
                  <th style={{width:"18%"}} className="right">単価</th>
                  <th style={{width:"20%"}} className="right">金額</th>
                  <th className="no-print" style={{width:"70px"}}></th>
                </tr>
              </thead>
              <tbody>
                {est.items.map((it, idx) => {
                  const qty = Number(it.qty || 0);
                  const up  = Number(it.unitPrice || 0);
                  const amount = applyRounding(qty * up, est.rounding);
                  return (
                    <tr key={idx}>
                      <td><input value={it.name} onChange={e => updateItem(idx, "name", e.target.value)} /></td>
                      <td className="right"><input type="number" value={it.qty} onChange={e => updateItem(idx, "qty", e.target.value)} /></td>
                      <td className="right"><input type="number" value={it.unitPrice} onChange={e => updateItem(idx, "unitPrice", e.target.value)} /></td>
                      <td className="right">{yen(amount)}</td>
                      <td className="no-print">
                        <button onClick={() => removeItem(idx)}>削除</button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>

            <div className="actions no-print">
              <button onClick={addItem} className="primary">行を追加</button>
            </div>

            <div className="totals">
              <div></div>
              <table>
                <tbody>
                  <tr><th>小計</th><td className="right">{yen(subtotal)}</td></tr>
                  <tr><th>消費税</th><td className="right">{yen(tax)}</td></tr>
                  <tr><th>合計</th><td className="right"><strong>{yen(total)}</strong></td></tr>
                </tbody>
              </table>
            </div>

            <div className="actions no-print">
              <button onClick={saveDraft} className="primary">下書き保存</button>
              <button onClick={loadDraft}>下書き読込</button>
              <button onClick={newEstimate}>新規</button>
              <button onClick={printPDF} className="primary">印刷（PDF保存）</button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

